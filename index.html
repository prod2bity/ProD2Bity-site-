<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ProD2Bity IA Turbinada</title>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    margin: 0;
  }
  #chat {
    max-width: 600px;
    margin: auto;
    border: 2px solid #00d4ff;
    border-radius: 10px;
    padding: 15px;
    background: #1f1f1f;
    display: flex;
    flex-direction: column;
    height: 80vh;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding-right: 10px;
  }
  .msg {
    margin: 8px 0;
    padding: 8px 12px;
    border-radius: 15px;
    max-width: 80%;
    line-height: 1.4;
    white-space: pre-wrap;
  }
  .user {
    background: #0f0;
    color: #000;
    align-self: flex-end;
  }
  .bot {
    background: #00d4ff;
    color: #000;
    align-self: flex-start;
  }
  #inputRow {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  #input {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
  }
  button {
    background: #00d4ff;
    border: none;
    color: #000;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background: #00a1cc;
  }
  #imageInput {
    display: none;
  }
  #avatar {
    font-size: 50px;
    text-align: center;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<div id="chat" style="display:none;">
  <div id="avatar">ü§ñ</div>
  <div id="messages"></div>
  <div id="inputRow">
    <input type="text" id="input" placeholder="Digite sua mensagem..." autocomplete="off" />
    <button id="sendBtn" title="Enviar mensagem">Enviar</button>
    <button id="micBtn" title="Falar" aria-label="Falar">üéôÔ∏è</button>
    <button id="imgBtn" title="Enviar imagem" aria-label="Enviar imagem">üì∑</button>
    <input type="file" id="imageInput" accept="image/*" />
  </div>
</div>

<script>
  // Usu√°rios fixos para login simples
  const USERS = {
    'gabriel': '123456',
    'admin': 'admin123'
  };

  let username;
  const OPENAI_API_KEY = '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';

  const chat = document.getElementById('chat');
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const micBtn = document.getElementById('micBtn');
  const imgBtn = document.getElementById('imgBtn');
  const imageInput = document.getElementById('imageInput');
  const avatarEl = document.getElementById('avatar');

  // Hist√≥rico de mensagens
  let history = JSON.parse(localStorage.getItem('prod2bity_history')) || [];

  // Atualiza avatar emoji conforme sentimento simples (palavras-chave)
  function updateAvatarMood(text) {
    const positive = ['bom', '√≥timo', 'legal', 'adoro', 'gostei', 'feliz', 'engra√ßado'];
    const negative = ['triste', 'ruim', 'p√©ssimo', '√≥dio', 'chateado', 'raiva'];

    const lower = text.toLowerCase();

    if (positive.some(w => lower.includes(w))) avatarEl.textContent = 'üòÑ';
    else if (negative.some(w => lower.includes(w))) avatarEl.textContent = 'üòû';
    else avatarEl.textContent = 'ü§ñ';
  }

  // Salva e mostra hist√≥rico ao carregar
  function loadHistory() {
    messagesEl.innerHTML = '';
    history.forEach(({ sender, text }) => {
      addMessage(sender, text, sender === username ? 'user' : 'bot');
    });
  }

  // Adiciona mensagem e salva no hist√≥rico
  function addMessage(sender, text, cls) {
    const div = document.createElement('div');
    div.className = 'msg ' + cls;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    history.push({ sender, text });
    localStorage.setItem('prod2bity_history', JSON.stringify(history));
  }

  // Fala o texto
  function speak(text) {
    if (!('speechSynthesis' in window)) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'pt-BR';
    speechSynthesis.speak(utterance);
  }

  // Converte arquivo para Base64
  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // Chamar API OpenAI ChatGPT
  async function queryChatAPI(messages) {
    try {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + OPENAI_API_KEY
        },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: messages,
          temperature: 0.7,
          max_tokens: 300
        })
      });
      if(!response.ok) {
        console.error('Erro HTTP:', response.status, await response.text());
        return "Erro na resposta da API.";
      }
      const data = await response.json();
      return data.choices[0].message.content.trim();
    } catch(e) {
      console.error('Erro na queryChatAPI:', e);
      return "Desculpe, n√£o consegui responder no momento.";
    }
  }

  // Fun√ß√£o para analisar imagens via HuggingFace (exemplo)
  async function queryImageAPI(base64image) {
    try {
      const response = await fetch('https://huggingface-api-proxy.vercel.app/api/vision', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'Salesforce/blip-image-captioning-base',
          image: base64image
        })
      });
      const data = await response.json();
      return data.caption || "N√£o consegui entender a imagem.";
    } catch {
      return "N√£o consegui analisar a imagem agora.";
    }
  }

  // Envia texto para IA
  async function sendText(text) {
    addMessage(username, text, 'user');
    updateAvatarMood(text);

    const messages = [
      { role: "system", content: "Voc√™ √© a ProD2Bity IA, inteligente e amig√°vel. Responda em portugu√™s." }
    ];

    history.forEach(h => {
      if(h.sender === username) {
        messages.push({ role: "user", content: h.text });
      } else {
        messages.push({ role: "assistant", content: h.text });
      }
    });

    messages.push({ role: "user", content: text });

    const reply = await queryChatAPI(messages);
    addMessage('ProD2Bity IA', reply, 'bot');
    updateAvatarMood(reply);
    speak(reply);
  }

  // Envia imagem para IA
  async function sendImage(file) {
    addMessage(username, '[Imagem enviada]', 'user');
    updateAvatarMood('imagem enviada');
    const base64 = await toBase64(file);
    const caption = await queryImageAPI(base64);
    addMessage('ProD2Bity IA', `Descri√ß√£o da imagem: ${caption}`, 'bot');
    updateAvatarMood(caption);
    speak(caption);
  }

  // Login simples
  async function login() {
    let user = sessionStorage.getItem('prod2bity_user');
    if(user) return user;

    while(true) {
      user = prompt('Digite seu nome de usu√°rio:');
      if(!user) {
        alert('Nome de usu√°rio obrigat√≥rio!');
        continue;
      }
      user = user.toLowerCase();

      if(!USERS[user]) {
        alert('Usu√°rio n√£o encontrado.');
        continue;
      }

      const pass = prompt('Digite sua senha:');
      if(!pass) {
        alert('Senha obrigat√≥ria!');
        continue;
      }

      if(USERS[user] === pass) {
        sessionStorage.setItem('prod2bity_user', user);
        alert('Login realizado com sucesso!');
        return user;
      } else {
        alert('Senha incorreta.');
      }
    }
  }

  // Eventos e listeners
  sendBtn.onclick = () => {
    const text = inputEl.value.trim();
    if (text) {
      sendText(text);
      inputEl.value = '';
    }
  };

  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendBtn.click();
  });

  micBtn.onclick = () => {
    if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
      alert('Seu navegador n√£o suporta reconhecimento de voz.');
      return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = e => {
      const speechText = e.results[0][0].transcript;
      inputEl.value = speechText;
      sendBtn.click();
    };

    recognition.onerror = e => {
      alert('Erro no reconhecimento de voz: ' + e.error);
    };

    recognition.start();
  };

  imgBtn.onclick = () => imageInput.click();

  imageInput.onchange = () => {
    const file = imageInput.files[0];
    if (file) sendImage(file);
  };

  // Inicializa√ß√£o
  (async () => {
    username = await login();
    chat.style.display = 'flex';
    loadHistory();
  })();
</script>

</body>
</html>
