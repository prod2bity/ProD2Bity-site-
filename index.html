<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ProD2Bity IA com Geração de Imagens Grátis</title>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    margin: 0;
  }
  #chat {
    max-width: 600px;
    margin: auto;
    border: 2px solid #00d4ff;
    border-radius: 10px;
    padding: 15px;
    background: #1f1f1f;
    display: flex;
    flex-direction: column;
    height: 80vh;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding-right: 10px;
  }
  .msg {
    margin: 8px 0;
    padding: 8px 12px;
    border-radius: 15px;
    max-width: 80%;
    line-height: 1.4;
  }
  .user {
    background: #0f0;
    color: #000;
    align-self: flex-end;
  }
  .bot {
    background: #00d4ff;
    color: #000;
    align-self: flex-start;
  }
  #inputRow {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  #input {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
  }
  #sendBtn {
    background: #00d4ff;
    border: none;
    color: #000;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #sendBtn:hover {
    background: #00a1cc;
  }
  img.chat-image {
    max-width: 80%;
    border-radius: 10px;
  }
</style>
</head>
<body>

<div id="chat" style="display:none;">
  <div id="messages"></div>
  <div id="inputRow">
    <input type="text" id="input" placeholder="Digite sua mensagem..." autocomplete="off" />
    <button id="sendBtn" title="Enviar mensagem">Enviar</button>
  </div>
</div>

<script>
  // Usuários fixos para login simples
  const USERS = {
    'gabriel': '123456',
    'admin': 'admin123'
  };

  let username;

  // Login simples
  async function login() {
    let user = sessionStorage.getItem('prod2bity_user');
    if(user) return user;

    while(true) {
      user = prompt('Digite seu nome de usuário:');
      if(!user) {
        alert('Nome de usuário obrigatório!');
        continue;
      }
      user = user.toLowerCase();

      if(!USERS[user]) {
        alert('Usuário não encontrado.');
        continue;
      }

      const pass = prompt('Digite sua senha:');
      if(!pass) {
        alert('Senha obrigatória!');
        continue;
      }

      if(USERS[user] === pass) {
        sessionStorage.setItem('prod2bity_user', user);
        alert('Login realizado com sucesso!');
        return user;
      } else {
        alert('Senha incorreta.');
      }
    }
  }

  // Elementos
  const chat = document.getElementById('chat');
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');

  // Histórico de mensagens
  let history = JSON.parse(localStorage.getItem('prod2bity_history')) || [];

  // Adicionar mensagem texto
  function addMessage(sender, text, cls) {
    const div = document.createElement('div');
    div.className = 'msg ' + cls;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    history.push({ sender, text });
    localStorage.setItem('prod2bity_history', JSON.stringify(history));
  }

  // Adicionar mensagem imagem
  function addImageMessage(sender, imageSrc, cls) {
    const div = document.createElement('div');
    div.className = 'msg ' + cls;
    const img = document.createElement('img');
    img.src = imageSrc;
    img.className = 'chat-image';
    div.appendChild(img);
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    history.push({ sender, text: '[imagem]', imageSrc });
    localStorage.setItem('prod2bity_history', JSON.stringify(history));
  }

  // Carregar histórico
  function loadHistory() {
    messagesEl.innerHTML = '';
    history.forEach(item => {
      if(item.imageSrc) {
        addImageMessage(item.sender, item.imageSrc, item.sender === username ? 'user' : 'bot');
      } else {
        addMessage(item.sender, item.text, item.sender === username ? 'user' : 'bot');
      }
    });
  }

  // Geração gratuita de imagem via HuggingFace proxy
  async function generateImageFree(prompt) {
    try {
      const res = await fetch('https://huggingface-api-proxy.vercel.app/api/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'stabilityai/stable-diffusion-2',
          prompt: prompt,
          width: 512,
          height: 512,
          steps: 30,
        })
      });
      const data = await res.json();
      if(data.image) return `data:image/png;base64,${data.image}`;
      else return null;
    } catch(e) {
      return null;
    }
  }

  // Chamar API de chat (texto)
  async function queryChatAPI(prompt) {
    try {
      const response = await fetch('https://huggingface-api-proxy.vercel.app/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt,
          model: 'mistralai/Mistral-7B-Instruct-v0.1',
          temperature: 0.7,
          max_tokens: 300
        })
      });
      const data = await response.json();
      return data.text.trim();
    } catch {
      return "Desculpe, não consegui responder no momento.";
    }
  }

  // Enviar mensagem (texto ou comando imagem)
  async function sendText(text) {
    addMessage(username, text, 'user');

    // Detectar comando gerar imagem
    const lower = text.toLowerCase();
    if(lower.startsWith('gerar imagem de') || lower.startsWith('gerar imagem')) {
      const prompt = text.replace(/gerar imagem( de)?/i, '').trim();
      if(!prompt) {
        addMessage('ProD2Bity IA', 'Por favor, especifique o que deseja na imagem.', 'bot');
        return;
      }
      addMessage('ProD2Bity IA', 'Gerando imagem, aguarde...', 'bot');
      const imageSrc = await generateImageFree(prompt);
      if(imageSrc) {
        addImageMessage('ProD2Bity IA', imageSrc, 'bot');
      } else {
        addMessage('ProD2Bity IA', 'Não consegui gerar a imagem.', 'bot');
      }
      return;
    }

    // Senão, conversa normal
    let context = 'Você é a ProD2Bity IA, inteligente e amigável. Responda em português.\n';
    history.forEach(h => {
      context += `${h.sender === username ? 'Usuário' : 'IA'}: ${h.text}\n`;
    });
    context += `Usuário: ${text}\nIA:`;

    const reply = await queryChatAPI(context);
    addMessage('ProD2Bity IA', reply, 'bot');
  }

  // Eventos
  sendBtn.onclick = () => {
    const text = inputEl.value.trim();
    if(text) {
      sendText(text);
      inputEl.value = '';
    }
  };

  inputEl.addEventListener('keydown', e => {
    if(e.key === 'Enter') sendBtn.click();
  });

  // Inicialização
  (async () => {
    username = await login();
    chat.style.display = 'flex';
    loadHistory();
  })();
</script>

</body>
</html>
